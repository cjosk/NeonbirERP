<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Neonbirr ERP Yönetim Paneli (Optimize)</title>
  <link rel="icon" type="image/png" href="https://i.hizliresim.com/5sdk6we.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
    .text-neonbirr { color: #FF5A36; }
    .bg-neonbirr { background-color: #FF5A36; }
    .hover\:bg-neonbirr-dark:hover { background-color: #e65231; }
    .sidebar-nav::-webkit-scrollbar { width: 6px; }
    .sidebar-nav::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 3px; }
    .sidebar-nav::-webkit-scrollbar-track { background-color: #f3f4f6; }
    tr:hover { transition: background 0.2s ease; }
  </style>
</head>
<body class="text-gray-800">
  <div id="message-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
  <div id="app" class="min-h-screen flex items-center justify-center">Yükleniyor...</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, query, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAB0UsTKcsRu2JBm2bAYIDHTz_qLS1WATA",
      authDomain: "neonbirfranchisee.firebaseapp.com",
      projectId: "neonbirfranchisee",
      storageBucket: "neonbirfranchisee.firebasestorage.app",
      messagingSenderId: "51668421951",
      appId: "1:51668421951:web:7d94456ebe84bba439578a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    let currentUserId = null;
    let currentRole = null;
    let currentPage = 'dashboard';
    let unsubscribeOrders = null;
    window.imageCache = {};
    let renderBatchSize = 40;
    let currentRenderIndex = 0;
    let isRendering = false;

    const getStatusColor = (status, isDelayed) => {
      if (isDelayed) return 'bg-red-500 text-white';
      switch (status) {
        case 'Çizildi': return 'bg-blue-100 text-blue-800';
        case 'Üretimi Tamamlandı': return 'bg-green-100 text-green-800';
        case 'Kargo Aşamasında': return 'bg-yellow-100 text-yellow-800';
        default: return 'bg-gray-100 text-gray-800';
      }
    };

    const checkIfDelayed = (order) => {
      return order.status !== 'Gönderilen Ürünler' && new Date() - new Date(order.orderDate) > 14 * 86400000;
    };

    const showMessage = (text, type = 'info') => {
      const container = document.getElementById('message-container');
      const color = type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500';
      const div = document.createElement('div');
      div.className = `${color} text-white px-4 py-2 rounded-lg shadow-xl`;
      div.textContent = text;
      container.prepend(div);
      setTimeout(() => div.remove(), 4000);
    };

    const renderOrderListChunked = () => {
      if (isRendering) return;
      isRendering = true;

      const tableBody = document.getElementById('orderTableBody');
      if (!tableBody) { isRendering = false; return; }

      let filteredOrders = window.orders || [];
      const renderNextChunk = () => {
        const start = currentRenderIndex;
        const end = Math.min(start + renderBatchSize, filteredOrders.length);
        const slice = filteredOrders.slice(start, end);

        const html = slice.map(order => {
          const isDelayed = checkIfDelayed(order);
          const statusColor = getStatusColor(order.status, isDelayed);
          const cachedUrl = window.imageCache[order.imageUrl] || order.imageUrl;
          if (!window.imageCache[order.imageUrl]) {
            const img = new Image();
            img.src = order.imageUrl;
            img.onload = () => { window.imageCache[order.imageUrl] = order.imageUrl; };
          }

          return `
            <tr class="border-b hover:bg-gray-50 cursor-pointer">
              <td class="p-3"><img loading="lazy" src="${cachedUrl}" class="w-10 h-10 rounded-lg object-cover shadow-sm"></td>
              <td class="p-3"><span class="px-3 py-1 text-xs font-medium rounded-full ${statusColor}">${isDelayed ? 'Gecikti' : order.status}</span></td>
              <td class="p-3 font-semibold">${order.customerName}</td>
              <td class="p-3 text-sm">${order.productName}</td>
              <td class="p-3 text-sm font-bold text-green-600">${(order.totalPrice || 0).toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' })}</td>
            </tr>
          `;
        }).join('');

        requestAnimationFrame(() => {
          tableBody.insertAdjacentHTML('beforeend', html);
          currentRenderIndex = end;
          isRendering = false;
        });

        if (end < filteredOrders.length) setupScrollLoader(filteredOrders.length);
      };
      renderNextChunk();
    };

    const setupScrollLoader = (totalCount) => {
      const container = document.querySelector('main');
      if (!container) return;
      const onScroll = () => {
        if (isRendering) return;
        if (currentRenderIndex >= totalCount) {
          container.removeEventListener('scroll', onScroll);
          return;
        }
        if (container.scrollTop + container.clientHeight >= container.scrollHeight - 150) {
          renderOrderListChunked();
        }
      };
      container.addEventListener('scroll', onScroll);
    };

    window.setupOrderListener = () => {
      if (unsubscribeOrders) unsubscribeOrders();
      const q = query(collection(db, 'artifacts/neonbirfranchisee/public/data/orders'));
      unsubscribeOrders = onSnapshot(q, (snapshot) => {
        window.orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        currentRenderIndex = 0;
        const tableBody = document.getElementById('orderTableBody');
        if (tableBody) tableBody.innerHTML = '';
        renderOrderListChunked();
      }, (error) => console.error(error));
    };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUserId = user.uid;
        currentRole = 'admin';
        document.getElementById('app').innerHTML = `
          <main class="p-6">
            <h1 class="text-2xl font-bold mb-4 text-neonbirr">Sipariş Listesi</h1>
            <div class="bg-white rounded-xl shadow-lg overflow-x-auto transition-opacity duration-300">
              <table class="min-w-full text-left border-collapse">
                <thead class="bg-gray-100">
                  <tr>
                    <th class="p-3">Görsel</th>
                    <th class="p-3">Durum</th>
                    <th class="p-3">Müşteri</th>
                    <th class="p-3">Ürün</th>
                    <th class="p-3">Tutar</th>
                  </tr>
                </thead>
                <tbody id="orderTableBody"></tbody>
              </table>
            </div>
          </main>`;
        window.setupOrderListener();
      } else {
        document.getElementById('app').innerHTML = `
          <div class="flex flex-col items-center justify-center min-h-screen">
            <h1 class="text-2xl font-semibold mb-4">Neonbirr ERP Girişi</h1>
            <input id="email" type="email" placeholder="E-posta" class="border p-2 rounded mb-2 w-64" />
            <input id="password" type="password" placeholder="Şifre" class="border p-2 rounded mb-4 w-64" />
            <button id="loginBtn" class="bg-neonbirr text-white px-4 py-2 rounded">Giriş Yap</button>
          </div>`;
        document.getElementById('loginBtn').addEventListener('click', async () => {
          const email = document.getElementById('email').value;
          const password = document.getElementById('password').value;
          try {
            await signInWithEmailAndPassword(auth, email, password);
          } catch (e) {
            showMessage('Giriş başarısız: ' + e.message, 'error');
          }
        });
      }
    });
  </script>
</body>
</html>
